#pragma once

////////////////////////////////////////////////////////////
// Headers
////////////////////////////////////////////////////////////

#include <nlohmann/json.hpp>

#include "../IInstructionSetRepository.h"

namespace ls6502
{

/////////////////////////////////////////////////////////////////////
///
/// Typedefs
///
/////////////////////////////////////////////////////////////////////
typedef std::unordered_map<std::string, Instruction> InstructionSetMapT;

/////////////////////////////////////////////////////////////////////
///
/// @class JSONInstructionSetRepository
///
/// @brief Loads and manages instruction set data from a JSON file
///
/////////////////////////////////////////////////////////////////////
class JSONInstructionSetRepository : public IInstructionSetRepository
{
public:
    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads the instruction set from a JSON file
    ///
    /// @return A map of instruction names to Instruction objects
    ///
    /////////////////////////////////////////////////////////////////////
    InstructionSetMapT load() override;

private:
    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads instruction set data from an input file stream
    ///
    /// @param [in] in
    ///
    /////////////////////////////////////////////////////////////////////
    void load(std::ifstream& in);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Parses instruction set data from a JSON object
    ///
    /// @param [in] jsonData
    ///
    /////////////////////////////////////////////////////////////////////
    void loadInstructionSet(const nlohmann::json& jsonData);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads mnemonic details into an instruction object
    ///
    /// @param [in] jsonData
    /// @param [in] instruction
    ///
    /////////////////////////////////////////////////////////////////////
    void loadMnemonic(const nlohmann::json& jsonData, Instruction& instruction);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads the description of an instruction
    ///
    /// @param [in] jsonData
    /// @param [in] instruction
    ///
    /////////////////////////////////////////////////////////////////////
    void loadDescription(const nlohmann::json& jsonData, Instruction& instruction);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads the operation details of an instruction
    ///
    /// @param [in] jsonData
    /// @param [in] instruction
    ///
    /////////////////////////////////////////////////////////////////////
    void loadOperation(const nlohmann::json& jsonData, Instruction& instruction);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads flag modifications associated with an instruction
    ///
    /// @param [in] jsonData
    /// @param [in] instruction
    ///
    /////////////////////////////////////////////////////////////////////
    void loadFlags(const nlohmann::json& jsonData, Instruction& instruction);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads addressing mode details
    ///
    /// @param [in] jsonData
    /// @param [in] instruction
    ///
    /////////////////////////////////////////////////////////////////////
    void loadAddressingMode(const nlohmann::json& jsonData, AddressingMode& instruction);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads the mode of an addressing mode object
    ///
    /// @param [in] jsonData
    /// @param [in] addressingMode
    ///
    /////////////////////////////////////////////////////////////////////
    void loadMode(const nlohmann::json& jsonData, AddressingMode& addressingMode);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads assembler syntax for an addressing mode
    ///
    /// @param [in] jsonData
    /// @param [in] addressingMode
    ///
    /////////////////////////////////////////////////////////////////////
    void loadAssembler(const nlohmann::json& jsonData, AddressingMode& addressingMode);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads opcode details for an addressing mode
    ///
    /// @param [in] jsonData
    /// @param [in] addressingMode
    ///
    /////////////////////////////////////////////////////////////////////
    void loadOpcode(const nlohmann::json& jsonData, AddressingMode& addressingMode);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads byte size details for an addressing mode
    ///
    /// @param [in] jsonData
    /// @param [in] addressingMode
    ///
    /////////////////////////////////////////////////////////////////////
    void loadBytes(const nlohmann::json& jsonData, AddressingMode& addressingMode);

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Loads cycle count details for an addressing mode
    ///
    /// @param [in] jsonData
    /// @param [in] addressingMode
    ///
    /////////////////////////////////////////////////////////////////////
    void loadCycles(const nlohmann::json& jsonData, AddressingMode& addressingMode);

private:
    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Map of instruction names to Instruction objects
    ///
    /////////////////////////////////////////////////////////////////////
    InstructionSetMapT m_instructionSet;

    /////////////////////////////////////////////////////////////////////
    ///
    /// @brief Path to the JSON instruction set
    ///
    /////////////////////////////////////////////////////////////////////

    // TODO change
    const char* INSTRUCTION_SET_FILE_PATH = "/home/josip/git/cpp/6502_LS/instructions/instructions.json";
};

} // namespace ls6502
